apiVersion: apps/v1
kind: Deployment
metadata:
  name: um-rag-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: um-rag-service
  template:
    metadata:
      labels:
        app: um-rag-service
    spec:
      serviceAccountName: um-vertex-ai-sa  # Service account with Workload Identity (see k8s/README.md)
      containers:
      - name: rag-service
        image: us-east1-docker.pkg.dev/teralivekubernetes/uplifted-mascot/um-rag-service:latest  # Will be replaced by Jenkins sed command
        ports:
        - containerPort: 8000
        env:
        - name: GCP_PROJECT_ID
          value: "teralivekubernetes"  # Hardcoded - no secrets needed
        - name: GCP_REGION
          value: "us-east1"
        - name: CHROMA_COLLECTION_NAME
          value: "uplifted_mascot"
        # Connect to ChromaDB service via HTTP (not file-based)
        - name: CHROMA_HOST
          value: "chromadb"  # Kubernetes service name
        - name: CHROMA_PORT
          value: "8000"
        # Rate limiting (requests per minute per IP)
        - name: RATE_LIMIT_PER_MINUTE
          value: "10"  # Adjust as needed (default: 10)
        # Token limits for Vertex AI (cost control)
        - name: MAX_OUTPUT_TOKENS
          value: "1024"  # Maximum tokens in AI response (default: 1024, max varies by model)
        - name: MAX_INPUT_TOKENS
          value: "4096"  # Maximum tokens in prompt (default: 4096, Gemini supports up to 1M+ but we cap for cost)
        # Optional: Vertex AI Vector Search (comment out if using ChromaDB only)
        # - name: VECTOR_INDEX_ID
        #   value: "your-index-id"
        # - name: VECTOR_ENDPOINT_ID
        #   value: "your-endpoint-id"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: um-rag-service
spec:
  type: ClusterIP
  selector:
    app: um-rag-service
  ports:
  - port: 80
    targetPort: 8000
    name: http

